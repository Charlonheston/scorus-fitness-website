---
/**
 * P√°gina Individual de Art√≠culo del Blog
 * Ruta din√°mica: /es/blog/[slug]
 * Estilo Netflix Minimalista Fitness
 */

import Layout from '@layouts/Layout.astro';
import { getArticleBySlug, getArticles, type StrapiArticle } from '@lib/strapi';
import { formatDate } from '@lib/utils';

export async function getStaticPaths() {
  try {
    const articles = await getArticles('es');
    
    if (!articles || articles.length === 0) {
      return [];
    }
    
    return articles.map((article) => ({
      params: { slug: article.attributes.slug },
      props: { article },
    }));
  } catch (error) {
    console.error('Error in getStaticPaths:', error);
    return [];
  }
}

const params = await Astro.params;
const article = Astro.props.article || await getArticleBySlug(params?.slug || '', 'es');

if (!article) {
  return Astro.redirect('/es/blog');
}

// Helper para obtener URL de imagen - versi√≥n mejorada con m√°s casos y debug
function getImageUrl(imgUrl: any): string | null {
  if (!imgUrl) {
    console.log('‚ö†Ô∏è getImageUrl: imgUrl is null/undefined');
    return null;
  }
  
  console.log('üîç getImageUrl input:', JSON.stringify(imgUrl, null, 2));
  
  // Helper para construir URL completa desde Strapi
  // IMPORTANTE: En Strapi v5, las im√°genes pueden venir con diferentes formatos
  function buildImageUrl(url: string): string {
    if (!url) return '';
    
    // Si ya es una URL completa, devolverla tal cual
    if (url.startsWith('http://') || url.startsWith('https://')) {
      return url;
    }
    
    const baseUrl = 'https://scorus-cms-strapi.onrender.com';
    
    // Si empieza con /, usar directamente
    if (url.startsWith('/')) {
      // En Strapi v5, puede ser /uploads/ o puede venir con formato diferente
      // Si la ruta /uploads/ da 404, podr√≠a ser que necesitemos usar /api/upload/files/
      // Pero primero intentemos con la ruta est√°ndar
      const fullUrl = `${baseUrl}${url}`;
      console.log('üîó Building URL from path:', url, '->', fullUrl);
      return fullUrl;
    }
    
    // Si no empieza con /, podr√≠a ser solo el nombre del archivo
    // Intentar con /uploads/ primero
    const fullUrl = `${baseUrl}/uploads/${url}`;
    console.log('üîó Building URL from filename:', url, '->', fullUrl);
    return fullUrl;
  }
  
  // CASO ESPECIAL: En Strapi v5, si tenemos el ID, podemos obtener la imagen desde la API
  // Pero primero intentemos con la URL que viene directamente
  // Si tenemos el ID, lo guardamos como alternativa
  let fileId: number | null = null;
  if (imgUrl?.data?.id) {
    fileId = imgUrl.data.id;
    console.log('üìé Found file ID:', fileId);
  }
  
  // Caso 1: imgUrl.data.attributes.url (estructura est√°ndar Strapi v5 con populate)
  if (imgUrl?.data?.attributes?.url) {
    let url = imgUrl.data.attributes.url;
    // Si la URL es relativa, construir la URL completa
    if (url && !url.startsWith('http')) {
      // En Strapi, las URLs pueden venir como /uploads/... o uploads/...
      if (url.startsWith('/')) {
        url = `https://scorus-cms-strapi.onrender.com${url}`;
      } else {
        url = `https://scorus-cms-strapi.onrender.com/${url}`;
      }
    }
    console.log('‚úÖ Found URL via data.attributes.url:', url);
    return url;
  }
  
  // Caso 2: imgUrl.data.url (estructura alternativa)
  if (imgUrl?.data?.url) {
    let url = imgUrl.data.url;
    if (url && !url.startsWith('http')) {
      if (url.startsWith('/')) {
        url = `https://scorus-cms-strapi.onrender.com${url}`;
      } else {
        url = `https://scorus-cms-strapi.onrender.com/${url}`;
      }
    }
    console.log('‚úÖ Found URL via data.url:', url);
    return url;
  }
  
  // Caso 3: imgUrl.attributes.url (sin wrapper data)
  if (imgUrl?.attributes?.url) {
    let url = imgUrl.attributes.url;
    if (url && !url.startsWith('http')) {
      if (url.startsWith('/')) {
        url = `https://scorus-cms-strapi.onrender.com${url}`;
      } else {
        url = `https://scorus-cms-strapi.onrender.com/${url}`;
      }
    }
    console.log('‚úÖ Found URL via attributes.url:', url);
    return url;
  }
  
  // Caso 4: imgUrl.url (directo)
  if (imgUrl?.url && typeof imgUrl.url === 'string') {
    let url = imgUrl.url;
    if (!url.startsWith('http')) {
      if (url.startsWith('/')) {
        url = `https://scorus-cms-strapi.onrender.com${url}`;
      } else {
        url = `https://scorus-cms-strapi.onrender.com/${url}`;
      }
    }
    console.log('‚úÖ Found URL via url:', url);
    return url;
  }
  
  // Caso 5: string directo
  if (typeof imgUrl === 'string') {
    let url = imgUrl;
    if (!url.startsWith('http')) {
      if (url.startsWith('/')) {
        url = `https://scorus-cms-strapi.onrender.com${url}`;
      } else {
        url = `https://scorus-cms-strapi.onrender.com/${url}`;
      }
    }
    console.log('‚úÖ Found URL as string:', url);
    return url;
  }
  
  console.log('‚ùå No valid URL found in imgUrl structure');
  console.log('Structure keys:', Object.keys(imgUrl || {}));
  return null;
}

const publishedDate = article.attributes.date 
  ? new Date(article.attributes.date)
  : (article.attributes.publishedAt 
      ? new Date(article.attributes.publishedAt)
      : new Date(article.attributes.createdAt));

const imageUrl = getImageUrl(article.attributes.imgUrl);
const categories = article.attributes.categories?.data || [];
const tags = article.attributes.tags?.data || [];
const author = article.attributes.author?.data;

// Debug: verificar estructura de imagen
console.log('üñºÔ∏è Image URL result:', imageUrl);
console.log('üì¶ imgUrl raw structure (COMPLETO):', JSON.stringify(article.attributes.imgUrl, null, 2));
console.log('üìã Article completo para debug:', JSON.stringify({
  id: article.id,
  title: article.attributes.title,
  imgUrl: article.attributes.imgUrl
}, null, 2));

const allArticles = await getArticles('es');
const relatedArticles = allArticles
  .filter((a) => a.id !== article.id)
  .slice(0, 3);
---

<Layout
  title={`${article.attributes.title} | Blog Scorus`}
  description={article.attributes.excerpt || (typeof article.attributes.content === 'string' 
    ? article.attributes.content.replace(/<[^>]*>/g, '').substring(0, 160) 
    : 'Art√≠culo del blog')}
>
  <!-- Hero Image - Estilo Netflix -->
  <section class="relative h-[60vh] min-h-[500px] overflow-hidden bg-black">
    {imageUrl ? (
      <div class="absolute inset-0 z-0">
        <picture>
          <source srcset={imageUrl} type="image/png" />
          <source srcset={imageUrl} type="image/jpeg" />
          <source srcset={imageUrl} type="image/webp" />
          <img 
            src={imageUrl} 
            alt={article.attributes.imageAlt || article.attributes.title}
            class="h-full w-full object-cover"
            loading="eager"
            decoding="async"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
            onerror={async (e) => {
              const img = e.target as HTMLImageElement;
              console.error('‚ùå Error cargando imagen:', imageUrl);
              console.error('URL intentada:', img.src);
              
              // Intentar alternativas
              const imgUrlData = article.attributes.imgUrl;
              let altUrl: string | null = null;
              
              // Opci√≥n 1: Usar ID para acceder v√≠a API
              if (imgUrlData?.data?.id) {
                altUrl = `https://scorus-cms-strapi.onrender.com/api/upload/files/${imgUrlData.data.id}`;
                console.warn('üí° Intentando URL alternativa v√≠a API con ID:', altUrl);
              }
              
              // Opci√≥n 2: Intentar con diferentes formatos de URL
              if (imageUrl && imageUrl.includes('/uploads/')) {
                // Si la URL tiene /uploads/ pero da 404, podr√≠a ser un problema de configuraci√≥n
                // Intentar sin /uploads/ o con otra ruta
                const withoutUploads = imageUrl.replace('/uploads/', '/');
                console.warn('üí° Intentando sin /uploads/:', withoutUploads);
                if (!altUrl) altUrl = withoutUploads;
              }
              
              if (altUrl) {
                img.src = altUrl;
              } else {
                console.warn('üì¶ Estructura completa imgUrl:', JSON.stringify(imgUrlData, null, 2));
              }
            }}
            onload={() => {
              console.log('‚úÖ Imagen cargada exitosamente:', imageUrl);
            }}
          />
        </picture>
        {/* Overlay gradiente m√°s ligero para que se vea mejor la imagen */}
        <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/50 to-black/30"></div>
      </div>
    ) : (
      <div class="absolute inset-0 z-0 bg-gradient-to-br from-gray-900 via-black to-gray-900 flex items-center justify-center">
        <div class="text-center text-white p-8">
          <p class="text-lg font-bold mb-4">No hay imagen disponible</p>
          <p class="text-sm text-gray-400 mb-2">imageUrl: {imageUrl || 'null'}</p>
          <details class="text-left text-xs text-gray-500 max-w-2xl">
            <summary class="cursor-pointer mb-2">Ver estructura completa de imgUrl</summary>
            <pre class="bg-black/50 p-4 rounded overflow-auto">{JSON.stringify(article.attributes.imgUrl, null, 2)}</pre>
          </details>
        </div>
      </div>
    )}
  </section>

  <!-- Breadcrumb Navigation -->
  <section class="bg-white py-4 border-b border-gray-200">
    <div class="container">
      <nav class="flex items-center gap-2 text-sm text-gray-600">
        <a href="/es" class="hover:text-red-600 transition-colors">Inicio</a>
        <span>/</span>
        <a href="/es/blog" class="hover:text-red-600 transition-colors">Blog</a>
        <span>/</span>
        <span class="text-gray-900 font-semibold truncate max-w-md">{article.attributes.title}</span>
      </nav>
    </div>
  </section>

  <!-- Article Header -->
  <section class="bg-white py-8">
    <div class="container">
      <div class="mx-auto max-w-4xl">
        {/* Autor con fecha - Estilo del blog de referencia */}
        {author && (
          <div class="mb-6 flex items-center gap-4">
            {author.attributes?.avatar?.data && (
              <img 
                src={getImageUrl(author.attributes.avatar) || ''} 
                alt={author.attributes.name}
                class="h-14 w-14 rounded-full object-cover ring-2 ring-gray-200"
                loading="lazy"
              />
            )}
            <div>
              <p class="font-bold text-gray-900">
                {author.attributes?.name || author.name}
              </p>
              <div class="flex items-center gap-2 text-sm text-gray-500">
                <span>‚Ä¢</span>
                <time>{formatDate(publishedDate, 'es-ES')}</time>
              </div>
            </div>
          </div>
        )}
        
        {/* T√≠tulo Principal */}
        <h1 class="mb-8 text-4xl font-black uppercase leading-tight tracking-tighter text-gray-900 md:text-5xl lg:text-6xl">
          {article.attributes.title}
        </h1>
        
        {/* Categor√≠as y Tags en l√≠nea */}
        <div class="mb-8 flex flex-wrap items-center gap-4">
          {/* Categor√≠as */}
          {categories.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {categories.map((category) => (
                <span 
                  class="inline-flex items-center gap-1 rounded-full bg-red-600 px-4 py-1.5 text-xs font-bold uppercase tracking-wider text-white"
                  style={category.attributes?.color ? `background-color: ${category.attributes.color}` : ''}
                >
                  {category.attributes?.icon && <span>{category.attributes.icon}</span>}
                  {category.attributes?.name || category.name}
                </span>
              ))}
            </div>
          )}
          
          {/* Tags estilo nube */}
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {tags.map((tag) => (
                <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-700 hover:bg-red-600 hover:text-white transition-colors">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                  </svg>
                  {tag.attributes?.name || tag.name}
                </span>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Article Content -->
  <article class="bg-white py-12">
    <div class="container">
      <div class="mx-auto max-w-4xl">
        {/* Contenido del art√≠culo */}
        <div 
          class="prose prose-lg prose-red max-w-none 
            prose-headings:font-black prose-headings:text-gray-900 prose-headings:uppercase prose-headings:tracking-tighter 
            prose-headings:mb-6 prose-headings:mt-10
            prose-h1:text-4xl prose-h2:text-3xl prose-h3:text-2xl
            prose-p:text-gray-700 prose-p:leading-relaxed prose-p:text-lg prose-p:mb-6
            prose-a:text-red-600 prose-a:no-underline prose-a:font-bold hover:prose-a:underline
            prose-strong:text-gray-900 prose-strong:font-black
            prose-ul:text-gray-700 prose-ul:space-y-3 prose-ul:my-6
            prose-ol:text-gray-700 prose-ol:space-y-3 prose-ol:my-6
            prose-li:text-gray-700 prose-li:text-lg prose-li:leading-relaxed
            prose-blockquote:border-l-4 prose-blockquote:border-red-600 prose-blockquote:pl-6 prose-blockquote:italic prose-blockquote:text-gray-600 prose-blockquote:my-8
            prose-code:text-red-600 prose-code:bg-gray-100 prose-code:px-2 prose-code:py-1 prose-code:rounded
            prose-pre:bg-gray-900 prose-pre:text-gray-100"
          set:html={typeof article.attributes.content === 'string' ? article.attributes.content : ''}
        />
      </div>
    </div>
  </article>

  <!-- Services Section (Similar to "¬øBuscas un barco de alquiler?" in reference) -->
  <section class="border-t border-gray-200 bg-gray-50 py-16">
    <div class="container">
      <div class="mx-auto max-w-6xl">
        <h2 class="mb-8 text-center text-3xl font-black uppercase tracking-tighter text-gray-900">
          ¬øBuscas nuestros <span class="text-red-600">Servicios</span>?
        </h2>
        <div class="grid gap-6 md:grid-cols-3">
          <a href="/es/servicios/entrenamiento-personal" class="group rounded-lg bg-white p-6 shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border border-gray-100">
            <h3 class="mb-3 text-xl font-black uppercase tracking-tight text-gray-900 group-hover:text-red-600 transition-colors">
              Entrenamiento Personal
            </h3>
            <p class="text-sm leading-relaxed text-gray-600">
              Programas personalizados adaptados a tus objetivos y nivel f√≠sico.
            </p>
            <span class="mt-4 inline-flex items-center gap-1 text-sm font-bold text-red-600 group-hover:gap-2 transition-all">
              Ver m√°s
              <svg class="h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </span>
          </a>
          <a href="/es/servicios/asesoramiento-online" class="group rounded-lg bg-white p-6 shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border border-gray-100">
            <h3 class="mb-3 text-xl font-black uppercase tracking-tight text-gray-900 group-hover:text-red-600 transition-colors">
              Asesoramiento Online
            </h3>
            <p class="text-sm leading-relaxed text-gray-600">
              Sistema completo con videoconsultas y seguimiento personalizado desde casa.
            </p>
            <span class="mt-4 inline-flex items-center gap-1 text-sm font-bold text-red-600 group-hover:gap-2 transition-all">
              Ver m√°s
              <svg class="h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </span>
          </a>
          <a href="/es/academia/scorus-campus" class="group rounded-lg bg-white p-6 shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border border-gray-100">
            <h3 class="mb-3 text-xl font-black uppercase tracking-tight text-gray-900 group-hover:text-red-600 transition-colors">
              Scorus Campus
            </h3>
            <p class="text-sm leading-relaxed text-gray-600">
              Experiencia exclusiva de entrenamiento intensivo de 7 d√≠as con alojamiento.
            </p>
            <span class="mt-4 inline-flex items-center gap-1 text-sm font-bold text-red-600 group-hover:gap-2 transition-all">
              Ver m√°s
              <svg class="h-4 w-4 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
              </svg>
            </span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Author Section - Estilo minimalista -->
  {author && (author.attributes?.bio || author.attributes?.socialLinks) && (
    <section class="border-t border-gray-200 bg-white py-12">
      <div class="container">
        <div class="mx-auto max-w-4xl">
          <div class="flex flex-col gap-6 md:flex-row md:items-start">
            {/* Avatar */}
            {author.attributes?.avatar?.data && (
              <div class="flex-shrink-0">
                <img 
                  src={getImageUrl(author.attributes.avatar) || ''} 
                  alt={author.attributes.name}
                  class="h-20 w-20 rounded-full object-cover ring-2 ring-gray-200"
                  loading="lazy"
                />
              </div>
            )}
            
            {/* Info del autor */}
            <div class="flex-1">
              <h3 class="mb-2 text-2xl font-black uppercase tracking-tighter text-gray-900">
                {author.attributes?.name || author.name}
              </h3>
              {author.attributes?.title && (
                <p class="mb-4 text-sm font-semibold uppercase tracking-wider text-red-600">
                  {author.attributes.title}
                </p>
              )}
              
              {author.attributes?.bio && (
                <div 
                  class="prose prose-sm max-w-none text-gray-700 prose-p:leading-relaxed"
                  set:html={typeof author.attributes.bio === 'string' ? author.attributes.bio : ''}
                />
              )}
              
              {/* Social Links */}
              {author.attributes?.socialLinks && author.attributes.socialLinks.length > 0 && (
                <div class="mt-4 flex gap-3">
                  {author.attributes.socialLinks.map((social: any) => (
                    <a 
                      href={social.url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-900 text-white transition-all duration-300 hover:bg-red-600 hover:scale-110"
                      aria-label={social.platform}
                    >
                      <span class="text-sm font-bold uppercase">
                        {social.platform.charAt(0)}
                      </span>
                    </a>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Related Articles -->
  {relatedArticles.length > 0 && (
    <section class="border-t border-gray-200 bg-white py-16">
      <div class="container">
        <div class="mx-auto max-w-6xl">
          {/* Header */}
          <h2 class="mb-8 text-3xl font-black uppercase tracking-tighter text-gray-900">
            Art√≠culos <span class="text-red-600">Relacionados</span>
          </h2>
          
          {/* Grid de art√≠culos relacionados */}
          <div class="grid gap-6 md:grid-cols-3">
            {relatedArticles.map((relatedArticle) => {
              if (!relatedArticle?.attributes?.title || !relatedArticle?.attributes?.slug) {
                return null;
              }

              const relatedDate = relatedArticle.attributes.date 
                ? new Date(relatedArticle.attributes.date)
                : (relatedArticle.attributes.publishedAt 
                    ? new Date(relatedArticle.attributes.publishedAt)
                    : new Date(relatedArticle.attributes.createdAt));
              
              const relatedImageUrl = getImageUrl(relatedArticle.attributes.imgUrl);
              const relatedCategories = relatedArticle.attributes.categories?.data || [];
              const relatedExcerpt = relatedArticle.attributes.excerpt || '';
              
              return (
                <a 
                  href={`/es/blog/${relatedArticle.attributes.slug}`}
                  class="group block overflow-hidden rounded-lg bg-white shadow-lg transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border border-gray-100"
                >
                  {/* Imagen */}
                  {relatedImageUrl ? (
                    <div class="relative h-48 overflow-hidden">
                      <img 
                        src={relatedImageUrl} 
                        alt={relatedArticle.attributes.title}
                        class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110"
                        loading="lazy"
                      />
                      <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    </div>
                  ) : (
                    <div class="h-48 bg-gradient-to-br from-gray-800 to-black"></div>
                  )}
                  
                  {/* Contenido */}
                  <div class="p-6">
                    {/* Categor√≠as */}
                    {relatedCategories.length > 0 && (
                      <div class="mb-2 flex flex-wrap gap-2">
                        {relatedCategories.slice(0, 1).map((category) => (
                          <span 
                            class="inline-flex items-center gap-1 rounded-full bg-red-600 px-2.5 py-1 text-xs font-bold uppercase tracking-wider text-white"
                            style={category.attributes?.color ? `background-color: ${category.attributes.color}` : ''}
                          >
                            {category.attributes?.icon && <span>{category.attributes.icon}</span>}
                            {category.attributes?.name || category.name}
                          </span>
                        ))}
                      </div>
                    )}
                    
                    <time class="mb-2 block text-xs font-semibold text-gray-500">
                      {formatDate(relatedDate, 'es-ES')}
                    </time>
                    
                    <h3 class="mb-2 text-xl font-black uppercase leading-tight tracking-tighter text-gray-900 transition-colors group-hover:text-red-600">
                      {relatedArticle.attributes.title}
                    </h3>
                    
                    {relatedExcerpt && (
                      <p class="line-clamp-2 text-sm leading-relaxed text-gray-600">
                        {relatedExcerpt}
                      </p>
                    )}
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      </div>
    </section>
  )}
</Layout>

<style>
  .prose img {
    @apply rounded-2xl shadow-2xl my-8 border-4 border-gray-200;
  }
  
  .prose h1, .prose h2, .prose h3 {
    @apply border-b-2 border-red-600 pb-3 mb-4;
  }
  
  .prose pre {
    @apply bg-gray-900 text-gray-100 rounded-xl p-6 overflow-x-auto shadow-xl border-2 border-gray-800;
  }
  
  .prose code {
    @apply bg-red-50 text-red-600 px-2 py-1 rounded font-mono text-sm;
  }
  
  .prose pre code {
    @apply bg-transparent text-gray-100;
  }
  
  .prose blockquote {
    @apply my-8;
  }
  
  .prose ul li::marker,
  .prose ol li::marker {
    @apply text-red-600;
  }
  
  .prose a {
    @apply transition-all duration-200;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
