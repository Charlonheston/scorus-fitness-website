---
/**
 * Page Blog - Liste d'Articles
 * Fran칞ais - Style Netflix Minimaliste Fitness
 * SSR: Rendu c칪t칠 serveur pour afficher les articles mis  jour
 */

export const prerender = false;

import Layout from '@layouts/Layout.astro';
import { getArticles, type StrapiArticle } from '@lib/strapi';
import { formatDate } from '@lib/utils';

const articles = await getArticles('fr');

console.log('游닄 Articles fetched:', articles.length);
console.log('游늶 Sample article:', articles[0]);
// Debug: Verificar im치genes
articles.forEach((article, index) => {
  const imageUrl = getImageUrl(article.attributes.imgUrl);
  console.log(`Article ${index} imageUrl:`, imageUrl);
});

// Extraer todas las categor칤as 칰nicas de los art칤culos
const allCategories = new Map<string, { id: number; name: string; icon?: string; color?: string }>();
articles.forEach((article) => {
  const categories = article.attributes.categories?.data || [];
  categories.forEach((category) => {
    const categoryId = category.id.toString();
    const categoryName = category.attributes?.name || (category as any).name || '';
    if (categoryName && !allCategories.has(categoryId)) {
      allCategories.set(categoryId, {
        id: category.id,
        name: categoryName,
        icon: category.attributes?.icon || (category as any).icon,
        color: category.attributes?.color || (category as any).color || '#dc2626',
      });
    }
  });
});

// Ordenar art칤culos por fecha (m치s recientes primero)
const sortedArticles = [...articles].sort((a, b) => {
  const dateA = a.attributes.date 
    ? new Date(a.attributes.date).getTime()
    : (a.attributes.publishedAt 
        ? new Date(a.attributes.publishedAt).getTime()
        : new Date(a.attributes.createdAt).getTime());
  const dateB = b.attributes.date 
    ? new Date(b.attributes.date).getTime()
    : (b.attributes.publishedAt 
        ? new Date(b.attributes.publishedAt).getTime()
        : new Date(b.attributes.createdAt).getTime());
  return dateB - dateA; // Most recent first
});

// Helper para obtener URL de imagen
function getImageUrl(imgUrl: any): string | null {
  if (!imgUrl) {
    console.log('getImageUrl: imgUrl is null/undefined');
    return null;
  }
  
  // Caso 1: imgUrl.data.attributes.url o imgUrl.data.url
  if (typeof imgUrl === 'object' && imgUrl.data) {
    const url = imgUrl.data.attributes?.url || imgUrl.data.url || imgUrl.data.attributes?.data?.attributes?.url;
    if (url) {
      const fullUrl = url.startsWith('http') ? url : `https://scorus-cms-strapi.onrender.com${url}`;
      console.log('getImageUrl: Found URL in data.attributes:', fullUrl);
      return fullUrl;
    }
  }
  
  // Caso 2: imgUrl.attributes.url (objeto directo con attributes)
  if (typeof imgUrl === 'object' && imgUrl.attributes) {
    const url = imgUrl.attributes.url || imgUrl.attributes.data?.attributes?.url;
    if (url) {
      const fullUrl = url.startsWith('http') ? url : `https://scorus-cms-strapi.onrender.com${url}`;
      console.log('getImageUrl: Found URL in attributes:', fullUrl);
      return fullUrl;
    }
  }
  
  // Caso 3: imgUrl.url (objeto directo sin attributes)
  if (typeof imgUrl === 'object' && imgUrl.url) {
    const url = imgUrl.url;
    const fullUrl = url.startsWith('http') ? url : `https://scorus-cms-strapi.onrender.com${url}`;
    console.log('getImageUrl: Found URL directly:', fullUrl);
    return fullUrl;
  }
  
  // Caso 4: imgUrl es un objeto con id (necesita fetch)
  if (typeof imgUrl === 'object' && imgUrl.id && !imgUrl.url && !imgUrl.attributes) {
    console.log('getImageUrl: Found ID but no URL, using ID to construct URL:', imgUrl.id);
    // Intentar construir URL desde el hash si existe
    if (imgUrl.hash) {
      const ext = imgUrl.ext || '.jpg';
      return `https://scorus-cms-strapi.onrender.com/uploads/${imgUrl.hash}${ext}`;
    }
  }
  
  console.log('getImageUrl: No URL found, imgUrl structure:', JSON.stringify(imgUrl, null, 2));
  return null;
}

// Helper para truncar t칤tulos a un m치ximo de caracteres
function truncateTitle(title: string, maxLength: number = 60): string {
  if (!title || title.length <= maxLength) return title;
  return title.substring(0, maxLength).trim() + '...';
}

// Mapear nombres de iconos a SVG paths s칩lidos (Lucide filled)
function getIconSvg(iconName: string | undefined | null): { path: string; viewBox: string; isSolid?: boolean } | null {
  if (!iconName) return null;
  
  const iconMap: Record<string, { path: string; viewBox: string; isSolid?: boolean }> = {
    // Nutrici칩n - Apple (s칩lido simplificado)
    'apple': { 
      path: 'M12 2C8 2 7 5 7 8c0 5 4 10 5 11 1-1 5-6 5-11 0-3-1-6-5-6zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'nutrition': { 
      path: 'M12 2C8 2 7 5 7 8c0 5 4 10 5 11 1-1 5-6 5-11 0-3-1-6-5-6zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Suplementaci칩n - Pill (s칩lido)
    'supplement': { 
      path: 'M10.5 7.5a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9zm0 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm3-3a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9zm0 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'supplementation': { 
      path: 'M10.5 7.5a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9zm0 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm3-3a4.5 4.5 0 1 0 0 9 4.5 4.5 0 0 0 0-9zm0 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Transformaci칩n - Sparkles (s칩lido)
    'transformation': { 
      path: 'M12 2l2.5 7.5L22 12l-7.5 2.5L12 22l-2.5-7.5L2 12l7.5-2.5L12 2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Academia - GraduationCap (s칩lido)
    'academia': { 
      path: 'M12 3L1 9l11 6 9-4.91V17h2V9L12 3zm0 8l-5-2.5L12 6l5 2.5L12 11z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'academy': { 
      path: 'M12 3L1 9l11 6 9-4.91V17h2V9L12 3zm0 8l-5-2.5L12 6l5 2.5L12 11z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Entrenamiento/Fitness - Dumbbell (s칩lido con rect치ngulos)
    'training': { 
      path: 'M2 8h4v8H2V8zm18 0h4v8h-4V8zm5 5H5v-2h20v2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'fitness': { 
      path: 'M2 8h4v8H2V8zm18 0h4v8h-4V8zm5 5H5v-2h20v2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'workout': { 
      path: 'M2 8h4v8H2V8zm18 0h4v8h-4V8zm5 5H5v-2h20v2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'dumbbell': { 
      path: 'M2 8h4v8H2V8zm18 0h4v8h-4V8zm5 5H5v-2h20v2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Salud - Heart (s칩lido)
    'health': { 
      path: 'M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Dieta - Utensils (s칩lido)
    'diet': { 
      path: 'M3 2v7c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V2H3zm0 9v10c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V11H3zm12-6v12c0 1.1.9 2 2 2h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // M칰sculo - Zap (s칩lido)
    'muscle': { 
      path: 'M13 2L3 14h9l-1 8 10-12h-9l1-8z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Fuerza - Flame (s칩lido)
    'strength': { 
      path: 'M12 2C8 2 7 5 7 8c0 4 3 7 5 8 2-1 5-4 5-8 0-3-1-6-5-6zm0 18c-2 0-4-1.5-5-3 1-1.5 4-4.5 5-6 1 1.5 4 4.5 5 6-1 1.5-3 3-5 3z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Cardio - Activity (s칩lido)
    'cardio': { 
      path: 'M22 12h-4l-3 9L9 3l-3 9H2', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Yoga - Circle (s칩lido)
    'yoga': { 
      path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'meditation': { 
      path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Bienestar - Flower (s칩lido)
    'wellness': { 
      path: 'M12 2c-2.2 0-4 1.8-4 4v6c0 2.2 1.8 4 4 4s4-1.8 4-4V6c0-2.2-1.8-4-4-4zm0 12c-3.3 0-6 2.7-6 6v2h12v-2c0-3.3-2.7-6-6-6z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Prote칤na - Drumstick (s칩lido)
    'protein': { 
      path: 'M15.5 17c-2.3 1.9-5.5 2.8-8.5 2.4L3 21l1.6-4c-.4-3 .5-6.2 2.4-8.5L15.5 17zm5-10c-.6-.6-1.5-1-2.5-1-.6 0-1.2.2-1.7.5L18 9.3c.3-.5.5-1.1.5-1.7 0-1-.4-1.9-1-2.5z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    // Peso - Scale (s칩lido)
    'weight': { 
      path: 'M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 5h2v8h-2V8z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
    'scale': { 
      path: 'M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 5h2v8h-2V8z', 
      viewBox: '0 0 24 24',
      isSolid: true
    },
  };
  
  const normalizedName = iconName.toLowerCase().trim();
  return iconMap[normalizedName] || null;
}

const currentLang = 'fr';
---

<Layout
  title="Blog | Scorus Fitness"
  description="Articles sur le fitness, la nutrition et l'entra칥nement"
>
  <!-- Hero Section -->
  <section class="relative flex min-h-[60vh] items-center justify-center overflow-hidden bg-black py-24 text-white">
    <!-- Hero Background Image con overlay -->
    <div class="absolute inset-0">
      <picture class="h-full w-full block">
        <source srcset="/images/hero/gym-hero-blog.jpeg" type="image/jpeg" />
        <img 
          src="/images/hero/gym-hero-blog.jpeg" 
          alt="Gimnasio moderno con equipamiento de fitness" 
          class="h-full w-full object-cover object-center" 
          loading="eager" 
          decoding="async" 
          fetchpriority="high"
        />
      </picture>
      <!-- Overlay oscuro para legibilidad del texto -->
      <div class="absolute inset-0 bg-gradient-to-br from-black/80 via-black/70 to-black/80"></div>
    </div>
    
    <div class="container relative z-10">
      <div class="mx-auto max-w-3xl text-center">
        <h1 class="mb-6 text-5xl font-black uppercase tracking-tighter md:text-6xl">
          Blog <span class="text-red-600">Scorus</span>
        </h1>
        <p class="text-xl text-gray-300">
          D칠couvrez les derniers articles sur le fitness, la nutrition et l'entra칥nement
        </p>
      </div>
    </div>
  </section>

  <!-- Articles Grid - Netflix Style -->
  <section class="bg-gradient-to-b from-gray-50 to-white py-16">
    <div class="container">
      {sortedArticles.length === 0 ? (
        <div class="py-20 text-center">
          <p class="text-xl text-gray-500">Aucun article disponible pour le moment.</p>
          <p class="mt-4 text-sm text-gray-600">Articles trouv칠s: {sortedArticles.length}</p>
        </div>
      ) : (
        <>
          {/* M칩dulo de Art칤culos Destacados */}
          {sortedArticles.length > 0 && (
            <div class="mb-12">
              <div class="grid gap-6 grid-cols-1 md:grid-cols-3 md:items-stretch md:min-h-[600px]">
                {/* Art칤culo Destacado - Izquierda (Grande) */}
                {sortedArticles[0] && (() => {
                  const featuredArticle = sortedArticles[0];
                  const featuredDate = featuredArticle.attributes.date 
                    ? new Date(featuredArticle.attributes.date)
                    : (featuredArticle.attributes.publishedAt 
                        ? new Date(featuredArticle.attributes.publishedAt)
                        : new Date(featuredArticle.attributes.createdAt));
                  const featuredImageUrl = getImageUrl(featuredArticle.attributes.imgUrl);
                  console.log('Featured article imageUrl:', featuredImageUrl, 'imgUrl data:', featuredArticle.attributes.imgUrl);
                  const featuredCategories = featuredArticle.attributes.categories?.data || [];
                  const featuredExcerpt = featuredArticle.attributes.excerpt || '';
                  
                  return (
                    <a 
                      href={`/fr/blog/${featuredArticle.attributes.slug}`}
                      class="group relative col-span-1 md:col-span-2 overflow-hidden rounded-2xl shadow-xl transition-all duration-500 hover:shadow-2xl hover:shadow-red-600/20 hover:-translate-y-2 w-full"
                    >
                      {featuredImageUrl ? (
                        <>
                          <img 
                            src={featuredImageUrl} 
                            alt={featuredArticle.attributes.imageAlt || featuredArticle.attributes.title}
                            class="absolute inset-0 h-full w-full object-cover transition-transform duration-700 ease-out group-hover:scale-105"
                            style="transform-origin: center center; will-change: transform; backface-visibility: hidden; -webkit-backface-visibility: hidden;"
                            loading="eager"
                          />
                          <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/70 to-black/90" style="backface-visibility: hidden; -webkit-backface-visibility: hidden;"></div>
                          <div class="absolute inset-0 bg-gradient-to-b from-red-600/0 via-red-600/0 to-red-600/0 transition-all duration-500 ease-out group-hover:from-red-600/20 group-hover:via-red-600/30 group-hover:to-red-600/40" style="backface-visibility: hidden; -webkit-backface-visibility: hidden;"></div>
                        </>
                      ) : (
                        <div class="absolute inset-0 bg-gradient-to-br from-gray-800 to-black"></div>
                      )}
                      
                      <div class="relative z-10 flex h-full flex-col justify-end p-8">
                        {featuredCategories.length > 0 && (
                          <div class="mb-4 flex flex-wrap gap-2">
                            {featuredCategories.slice(0, 2).map((category) => {
                              const categoryColor = category.attributes?.color || (category as any).color;
                              const categoryIconRaw = category.attributes?.icon || (category as any).icon;
                              const categoryIconSvg = getIconSvg(categoryIconRaw);
                              const categoryName = category.attributes?.name || (category as any).name;
                              const bgColor = categoryColor || '#dc2626';
                              return (
                                <span 
                                  class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-black uppercase tracking-wider text-white shadow-lg backdrop-blur-md border border-white/20"
                                  style={`background-color: ${bgColor};`}
                                >
                                  {categoryIconSvg && (
                                    <svg 
                                      class="w-4 h-4 flex-shrink-0" 
                                      fill={categoryIconSvg.isSolid ? "currentColor" : "none"}
                                      stroke={categoryIconSvg.isSolid ? "none" : "currentColor"}
                                      stroke-width={categoryIconSvg.isSolid ? "0" : "2"}
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      viewBox={categoryIconSvg.viewBox}
                                      style="color: white;"
                                    >
                                      <path d={categoryIconSvg.path} />
                                    </svg>
                                  )}
                                  <span>{categoryName}</span>
                                </span>
                              );
                            })}
                          </div>
                        )}
                        
                        <time class="mb-2 block text-xs font-bold uppercase tracking-widest text-gray-300">
                          {formatDate(featuredDate, 'fr-FR')}
                        </time>
                        
                        <h2 class="mb-3 text-3xl md:text-4xl font-black uppercase leading-tight tracking-tighter text-white drop-shadow-2xl transition-all duration-300 group-hover:text-red-400 group-hover:drop-shadow-[0_0_20px_rgba(220,38,38,0.5)]">
                          {featuredArticle.attributes.title}
                        </h2>
                        
                        {featuredExcerpt && (
                          <p class="mb-4 line-clamp-2 text-base leading-relaxed text-gray-200 drop-shadow-lg">
                            {featuredExcerpt}
                          </p>
                        )}
                      </div>
                    </a>
                  );
                })()}
                
                {/* Art칤culos Peque침os - Derecha */}
                <div class="flex flex-col gap-4 h-full">
                  {sortedArticles.slice(1, 3).map((article, idx) => {
                    const articleDate = article.attributes.date 
                      ? new Date(article.attributes.date)
                      : (article.attributes.publishedAt 
                          ? new Date(article.attributes.publishedAt)
                          : new Date(article.attributes.createdAt));
                    const articleImageUrl = getImageUrl(article.attributes.imgUrl);
                    console.log(`Small article ${idx} imageUrl:`, articleImageUrl, 'imgUrl data:', article.attributes.imgUrl);
                    const articleCategories = article.attributes.categories?.data || [];
                    
                    return (
                      <a 
                        href={`/fr/blog/${article.attributes.slug}`}
                        class="group relative flex-1 overflow-hidden rounded-xl shadow-lg transition-all duration-500 hover:shadow-xl hover:shadow-red-600/20 hover:-translate-y-1 min-h-0"
                      >
                        {articleImageUrl ? (
                          <div class="absolute inset-0">
                            <img 
                              src={articleImageUrl} 
                              alt={article.attributes.imageAlt || article.attributes.title}
                              class="h-full w-full object-cover transition-transform duration-700 ease-out group-hover:scale-105"
                              style="transform-origin: center center; will-change: transform; backface-visibility: hidden; -webkit-backface-visibility: hidden;"
                              loading="lazy"
                            />
                            <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/70 to-black/90" style="backface-visibility: hidden; -webkit-backface-visibility: hidden;"></div>
                            <div class="absolute inset-0 bg-gradient-to-b from-red-600/0 via-red-600/0 to-red-600/0 transition-all duration-500 ease-out group-hover:from-red-600/20 group-hover:via-red-600/30 group-hover:to-red-600/40" style="backface-visibility: hidden; -webkit-backface-visibility: hidden;"></div>
                          </div>
                        ) : (
                          <div class="absolute inset-0 bg-gradient-to-br from-gray-800 to-black"></div>
                        )}
                        
                        <div class="relative z-10 flex h-full flex-col justify-end p-4">
                          {articleCategories.length > 0 && (
                            <div class="mb-2">
                              {(() => {
                                const category = articleCategories[0];
                                const categoryColor = category.attributes?.color || (category as any).color;
                                const categoryIconRaw = category.attributes?.icon || (category as any).icon;
                                const categoryIconSvg = getIconSvg(categoryIconRaw);
                                const categoryName = category.attributes?.name || (category as any).name;
                                const bgColor = categoryColor || '#dc2626';
                                return (
                                  <span 
                                    class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-[10px] font-black uppercase tracking-wider text-white shadow-lg backdrop-blur-md border border-white/20"
                                    style={`background-color: ${bgColor};`}
                                  >
                                    {categoryIconSvg && (
                                      <svg 
                                        class="w-3 h-3 flex-shrink-0" 
                                        fill={categoryIconSvg.isSolid ? "currentColor" : "none"}
                                        stroke={categoryIconSvg.isSolid ? "none" : "currentColor"}
                                        stroke-width={categoryIconSvg.isSolid ? "0" : "2"}
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        viewBox={categoryIconSvg.viewBox}
                                        style="color: white;"
                                      >
                                        <path d={categoryIconSvg.path} />
                                      </svg>
                                    )}
                                    <span>{categoryName}</span>
                                  </span>
                                );
                              })()}
                            </div>
                          )}
                          
                          <h3 class="text-lg font-black uppercase leading-tight tracking-tighter text-white drop-shadow-2xl line-clamp-2 transition-all duration-300 group-hover:text-red-400">
                            {truncateTitle(article.attributes.title, 50)}
                          </h3>
                        </div>
                      </a>
                    );
                  })}
                </div>
              </div>
              
              {/* Breadcrumbs */}
              <nav class="mt-6 flex items-center gap-2 text-sm text-gray-600" aria-label="Breadcrumb">
                <a href="/fr" class="hover:text-red-600 transition-colors">Accueil</a>
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                </svg>
                <span class="text-gray-900 font-semibold">Blog</span>
              </nav>
            </div>
          )}
          
          {/* Barra de Filtros y Ordenamiento */}
          <div class="mb-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            {/* Filtros por Categor칤as */}
            <div class="flex flex-wrap gap-2">
              <button 
                class="category-filter active rounded-full px-4 py-2 text-sm font-semibold transition-all duration-300 bg-gray-900 text-white hover:bg-gray-800 shadow-md"
                data-category="all"
              >
                Tous
              </button>
              {Array.from(allCategories.values()).map((category) => {
                const categoryIconSvg = getIconSvg(category.icon);
                const bgColor = category.color || '#dc2626';
                return (
                  <button 
                    class="category-filter rounded-full px-4 py-2 text-sm font-semibold transition-all duration-300 bg-gray-200 text-gray-800 hover:bg-gray-300 shadow-md"
                    data-category={category.id}
                    style={`--category-color: ${bgColor};`}
                  >
                    {categoryIconSvg && (
                      <svg 
                        class="inline-block w-4 h-4 mr-1.5 align-middle" 
                        fill={categoryIconSvg.isSolid ? "currentColor" : "none"}
                        stroke={categoryIconSvg.isSolid ? "none" : "currentColor"}
                        stroke-width={categoryIconSvg.isSolid ? "0" : "2"}
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        viewBox={categoryIconSvg.viewBox}
                      >
                        <path d={categoryIconSvg.path} />
                      </svg>
                    )}
                    {category.name}
                  </button>
                );
              })}
            </div>
            
            {/* Ordenamiento */}
            <div class="flex items-center gap-2">
              <label for="sort-select" class="text-sm font-semibold text-gray-700">Trier:</label>
              <select 
                id="sort-select" 
                class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm transition-all duration-300 hover:border-gray-400 focus:border-red-600 focus:outline-none focus:ring-2 focus:ring-red-600/20"
              >
                <option value="recent">Plus r칠cents</option>
                <option value="oldest">Plus anciens</option>
              </select>
            </div>
          </div>

          {/* Grid de Art칤culos */}
          <div id="articles-grid" class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 auto-rows-fr">
            {sortedArticles.slice(3).map((article, index) => {
            console.log(`Processing article ${index}:`, article?.attributes?.title);
            
            if (!article?.attributes?.title || !article?.attributes?.slug) {
              console.warn(`Article ${index} skipped:`, { 
                hasTitle: !!article?.attributes?.title, 
                hasSlug: !!article?.attributes?.slug 
              });
              return null;
            }

            const publishedDate = article.attributes.date 
              ? new Date(article.attributes.date)
              : (article.attributes.publishedAt 
                  ? new Date(article.attributes.publishedAt)
                  : new Date(article.attributes.createdAt));
            
            const imageUrl = getImageUrl(article.attributes.imgUrl);
            console.log(`Grid article ${index} imageUrl:`, imageUrl, 'imgUrl data:', article.attributes.imgUrl);
            const excerpt = article.attributes.excerpt || '';
            const categories = article.attributes.categories?.data || [];
            const tags = article.attributes.tags?.data || [];
            const author = article.attributes.author?.data;
            
            // Crear lista de IDs de categor칤as para el atributo data
            const categoryIds = categories.map(cat => cat.id.toString()).join(',');
            
            return (
              <article 
                class="article-card group relative overflow-hidden w-full min-w-[320px] max-w-[450px] mx-auto rounded-2xl shadow-xl transition-all duration-500 hover:shadow-2xl hover:shadow-red-600/20 hover:-translate-y-3 flex flex-col opacity-100" 
                style="aspect-ratio: 3/4;"
                data-categories={categoryIds || 'none'}
                data-date={publishedDate.getTime()}
              >
                {/* Imagen de fondo Netflix-style */}
                {imageUrl ? (
                  <div class="absolute inset-0 z-0 overflow-hidden rounded-2xl">
                    <img 
                      src={imageUrl} 
                      alt={article.attributes.imageAlt || article.attributes.title}
                      class="absolute inset-0 w-full h-full object-cover rounded-2xl transition-transform duration-700 ease-out group-hover:scale-105"
                      style="transform-origin: center center; will-change: transform; backface-visibility: hidden; -webkit-backface-visibility: hidden;"
                      loading="lazy"
                      decoding="async"
                    />
                    {/* Overlay gradiente m치s sutil para que se vea mejor la imagen */}
                    <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/70 to-black/90 rounded-2xl" style="backface-visibility: hidden; -webkit-backface-visibility: hidden;"></div>
                    {/* Overlay rojo sutil al hover */}
                    <div class="absolute inset-0 bg-gradient-to-b from-red-600/0 via-red-600/0 to-red-600/0 transition-all duration-500 ease-out group-hover:from-red-600/20 group-hover:via-red-600/30 group-hover:to-red-600/40 rounded-2xl" style="backface-visibility: hidden; -webkit-backface-visibility: hidden;"></div>
                  </div>
                ) : (
                  <div class="absolute inset-0 z-0 bg-gradient-to-br from-gray-800 to-black rounded-2xl"></div>
                )}
                
                {/* Contenido con mejor contraste */}
                <div class="relative z-10 flex flex-col h-full p-6 overflow-hidden">
                  {/* Header con categor칤as - secci칩n flexible */}
                  <div class="flex-shrink-0 min-h-0">
                    {/* Categor칤as */}
                    {categories.length > 0 && (
                      <div class="mb-3 flex flex-wrap gap-2">
                        {categories.slice(0, 2).map((category) => {
                          const categoryColor = category.attributes?.color || (category as any).color;
                          const categoryIconRaw = category.attributes?.icon || (category as any).icon;
                          const categoryIconSvg = getIconSvg(categoryIconRaw);
                          const categoryName = category.attributes?.name || (category as any).name;
                          
                          const bgColor = categoryColor || '#dc2626';
                          return (
                            <span 
                              class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-black uppercase tracking-wider text-white shadow-lg backdrop-blur-md border border-white/20 transition-all hover:scale-105"
                              style={`background-color: ${bgColor};`}
                            >
                              {categoryIconSvg && (
                                <svg 
                                  class="w-4 h-4 md:w-5 md:h-5 flex-shrink-0" 
                                  fill={categoryIconSvg.isSolid ? "currentColor" : "none"}
                                  stroke={categoryIconSvg.isSolid ? "none" : "currentColor"}
                                  stroke-width={categoryIconSvg.isSolid ? "0" : "2"}
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  viewBox={categoryIconSvg.viewBox}
                                  style="color: white;"
                                >
                                  <path d={categoryIconSvg.path} />
                                </svg>
                              )}
                              <span>{categoryName}</span>
                            </span>
                          );
                        })}
                      </div>
                    )}
                    
                    {/* Fecha */}
                    <time class="mb-2 block text-xs font-bold uppercase tracking-widest text-gray-300">
                      {formatDate(publishedDate, 'fr-FR')}
                    </time>
                    
                    {/* T칤tulo truncado a m치ximo de caracteres para homogeneidad */}
                    <h2 class="mb-3 text-xl md:text-2xl font-black uppercase leading-tight tracking-tighter text-white drop-shadow-2xl line-clamp-3 transition-all duration-300 group-hover:text-red-400 group-hover:drop-shadow-[0_0_20px_rgba(220,38,38,0.5)]">
                      {truncateTitle(article.attributes.title, 60)}
                    </h2>
                    
                    {/* Excerpt - altura limitada */}
                    {excerpt && (
                      <p class="mb-3 line-clamp-2 text-sm leading-relaxed text-gray-200 drop-shadow-lg">
                        {excerpt}
                      </p>
                    )}
                  </div>
                  
                  {/* Footer con tags nube y autor - siempre en el fondo */}
                  <div class="flex-shrink-0 space-y-2 mt-auto pt-2">
                    {/* Tags estilo nube - m치ximo 2 tags visibles */}
                    {tags.length > 0 && (
                      <div class="flex flex-wrap gap-1.5">
                        {tags.slice(0, 2).map((tag) => (
                          <span class="group/tag inline-flex items-center gap-1 rounded-full bg-white/20 backdrop-blur-md px-2 py-1 text-xs font-semibold text-white transition-all duration-300 hover:bg-red-600 hover:scale-110 hover:shadow-lg border border-white/30">
                            <svg class="h-3 w-3 opacity-70 group-hover/tag:opacity-100" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                            </svg>
                            <span class="truncate max-w-[100px]">{tag.attributes?.name || (tag as any).name}</span>
                          </span>
                        ))}
                      </div>
                    )}
                    
                    {/* Autor con mejor visibilidad - m치s compacto */}
                    {author && (
                      <div class="flex items-center gap-2 rounded-lg bg-white/10 backdrop-blur-md p-2 border border-white/20">
                        {(author.attributes?.avatar as any)?.data && (
                          <img 
                            src={getImageUrl(author.attributes.avatar) || ''} 
                            alt={author.attributes.name}
                            class="h-8 w-8 rounded-full object-cover ring-2 ring-red-600 ring-offset-2 ring-offset-black/50 shadow-lg flex-shrink-0"
                            loading="lazy"
                          />
                        )}
                        <div class="flex-1 min-w-0">
                          <p class="text-xs font-black uppercase tracking-wider text-white drop-shadow-lg truncate">
                            {author.attributes?.name || (author as any).name}
                          </p>
                          {author.attributes?.title && (
                            <p class="text-[10px] font-semibold text-gray-300 mt-0.5 truncate">{author.attributes.title}</p>
                          )}
                        </div>
                      </div>
                    )}
                    
                    {/* CTA mejorado - m치s compacto */}
                    <div class="flex items-center justify-center gap-2 rounded-lg bg-red-600 px-4 py-2 text-xs font-black uppercase tracking-wider text-white shadow-lg transition-all duration-300 group-hover:bg-white group-hover:text-red-600 group-hover:scale-105 group-hover:shadow-xl group-hover:shadow-red-600/50">
                      Lire l'article
                      <svg class="h-5 w-5 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                      </svg>
                    </div>
                  </div>
                </div>
                
                {/* Link overlay */}
                <a href={`/fr/blog/${article.attributes.slug}`} class="absolute inset-0 z-20" aria-label={`Lire l'article: ${article.attributes.title}`}></a>
              </article>
            );
          })}
          </div>
          
          {/* Mensaje cuando no hay art칤culos filtrados */}
          <div id="no-results" class="hidden py-20 text-center">
            <p class="text-xl text-gray-500">Aucun article trouv칠 avec les filtres s칠lectionn칠s.</p>
          </div>
        </>
      )}
    </div>
  </section>
</Layout>

<script>
  // Sistema de Filtrado y Ordenamiento
  document.addEventListener('DOMContentLoaded', () => {
    const categoryFilters = document.querySelectorAll('.category-filter');
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    const articlesGrid = document.getElementById('articles-grid');
    const noResults = document.getElementById('no-results');
    const articleCards = document.querySelectorAll('.article-card');
    
    let currentCategory = 'all';
    let currentSort = 'recent';
    
    // Funci칩n para filtrar art칤culos
    function filterArticles() {
      let visibleCount = 0;
      
      articleCards.forEach((card) => {
        const articleElement = card as HTMLElement;
        const articleCategories = articleElement.getAttribute('data-categories') || '';
        
        // Filtrar por categor칤a
        let shouldShow = false;
        if (currentCategory === 'all') {
          shouldShow = true;
        } else {
          const categoryArray = articleCategories.split(',');
          shouldShow = categoryArray.includes(currentCategory);
        }
        
        // Mostrar/ocultar art칤culo
        if (shouldShow) {
          articleElement.style.display = 'flex';
          articleElement.style.opacity = '1';
          visibleCount++;
        } else {
          articleElement.style.display = 'none';
          articleElement.style.opacity = '0';
        }
      });
      
      // Mostrar mensaje si no hay resultados
      if (noResults && articlesGrid) {
        if (visibleCount === 0) {
          noResults.classList.remove('hidden');
          articlesGrid.classList.add('hidden');
        } else {
          noResults.classList.add('hidden');
          articlesGrid.classList.remove('hidden');
        }
      }
      
      // Ordenar art칤culos visibles
      sortArticles();
    }
    
    // Funci칩n para ordenar art칤culos
    function sortArticles() {
      const visibleArticles = Array.from(articleCards).filter(card => {
        const articleElement = card as HTMLElement;
        return articleElement.style.display !== 'none';
      });
      
      visibleArticles.sort((a, b) => {
        const dateA = parseInt((a as HTMLElement).getAttribute('data-date') || '0');
        const dateB = parseInt((b as HTMLElement).getAttribute('data-date') || '0');
        
        if (currentSort === 'recent') {
          return dateB - dateA; // Most recent first
        } else {
          return dateA - dateB; // Oldest first
        }
      });
      
      // Reordenar en el DOM
      const grid = articlesGrid;
      if (grid) {
        visibleArticles.forEach(article => {
          grid.appendChild(article);
        });
      }
    }
    
    // Event listeners para filtros de categor칤as
    categoryFilters.forEach((filter) => {
      filter.addEventListener('click', () => {
        // Remover clase active de todos los filtros
        categoryFilters.forEach(f => {
          f.classList.remove('active', 'bg-gray-900', 'text-white');
          f.classList.add('bg-gray-200', 'text-gray-800');
        });
        
        // A침adir clase active al filtro seleccionado
        filter.classList.add('active', 'bg-gray-900', 'text-white');
        filter.classList.remove('bg-gray-200', 'text-gray-800');
        
        // Actualizar categor칤a actual
        currentCategory = filter.getAttribute('data-category') || 'all';
        
        // Filtrar art칤culos
        filterArticles();
      });
    });
    
    // Event listener para ordenamiento
    if (sortSelect) {
      sortSelect.addEventListener('change', () => {
        currentSort = sortSelect.value;
        sortArticles();
      });
    }
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Asegurar que todos los cards tengan la misma altura */
  .auto-rows-fr > * {
    display: flex;
    flex-direction: column;
  }

  /* Asegurar altura m칤nima consistente en el grid */
  @media (min-width: 768px) {
    .auto-rows-fr {
      grid-auto-rows: 1fr;
    }
  }
  
  /* Transiciones suaves para mostrar/ocultar art칤culos */
  .article-card {
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
  }
  
  .category-filter.active {
    background-color: rgb(17, 24, 39) !important;
    color: white !important;
  }
  
  .category-filter:hover:not(.active) {
    background-color: rgb(229, 231, 235) !important;
  }
</style>
