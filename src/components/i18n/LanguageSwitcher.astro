---
/**
 * Language Switcher Component
 * Selector de idioma minimalista con traducci√≥n de rutas
 * Soporta art√≠culos de blog con localizaciones
 */

interface Props {
  // Opcional: informaci√≥n de localizaci√≥n para art√≠culos de blog
  articleLocalizations?: Array<{
    locale: string;
    slug: string;
  }>;
  // Opcional: slug del art√≠culo actual (para construir URLs de blog)
  currentSlug?: string;
  // Opcional: indicar si estamos en una p√°gina de blog
  isBlogPage?: boolean;
}

const { articleLocalizations, currentSlug, isBlogPage = false } = Astro.props;

// Debug: ver qu√© props llegan
if (isBlogPage) {
  console.log('üîç LanguageSwitcher Debug:', {
    isBlogPage,
    currentSlug,
    articleLocalizations,
    hasLocalizations: !!articleLocalizations,
    localizationsCount: articleLocalizations?.length || 0
  });
}

const languages = [
  { code: 'es', name: 'ES', fullName: 'Espa√±ol' },
  { code: 'en', name: 'EN', fullName: 'English' },
  { code: 'fr', name: 'FR', fullName: 'Fran√ßais' },
  { code: 'de', name: 'DE', fullName: 'Deutsch' },
  { code: 'hu', name: 'HU', fullName: 'Magyar' },
];

// Detectar idioma desde la URL
const currentPath = Astro.url.pathname;
const pathParts = currentPath.split('/').filter(Boolean);
const potentialLang = pathParts[0];
const currentLang = ['en', 'fr', 'de', 'hu'].includes(potentialLang) ? potentialLang : 'es';

// Mapa de traducci√≥n de rutas (ES es la base)
const routeTranslations = {
  // Servicios / Services / Services / Dienstleistungen / Szolg√°ltat√°sok
  'servicios': { en: 'services', fr: 'services', de: 'dienstleistungen', hu: 'szolgaltatasok' },
  'servicios/talleres': { en: 'services/workshops', fr: 'services/ateliers', de: 'dienstleistungen/workshops', hu: 'szolgaltatasok/workshopok' },
  'servicios/consultoria-online': { en: 'services/online-consulting', fr: 'services/consultation-en-ligne', de: 'dienstleistungen/online-beratung', hu: 'szolgaltatasok/online-tanacsadas' },
  'servicios/video-cursos': { en: 'services/video-courses', fr: 'services/cours-video', de: 'dienstleistungen/video-kurse', hu: 'szolgaltatasok/video-kurzusok' },
  'servicios/seminarios': { en: 'services/seminars', fr: 'services/seminaires', de: 'dienstleistungen/seminare', hu: 'szolgaltatasok/szeminariumok' },
  'servicios/entrenamiento-personal': { en: 'services/personal-training', fr: 'services/entrainement-personnel', de: 'dienstleistungen/personliches-training', hu: 'szolgaltatasok/szemelyi-edzes' },
  'servicios/asesoramiento-online': { en: 'services/online-counseling', fr: 'services/conseil-en-ligne', de: 'dienstleistungen/online-coaching', hu: 'szolgaltatasok/online-coaching' },
  
  // Academia / Academy / Acad√©mie / Akademie / Akad√©mia
  'academia': { en: 'academy', fr: 'academie', de: 'akademie', hu: 'akademia' },
  'academia/scorus-campus': { en: 'academy/scorus-campus', fr: 'academie/scorus-campus', de: 'akademie/scorus-campus', hu: 'akademia/scorus-campus' },
  'academia/re-born': { en: 'academy/re-born', fr: 'academie/re-born', de: 'akademie/re-born', hu: 'akademia/re-born' },
  'academia/seminarios': { en: 'academy/seminars', fr: 'academie/seminaires', de: 'akademie/seminare', hu: 'akademia/szeminarium' },
  
  // Otras p√°ginas / Other pages / Autres pages / Andere Seiten / M√°s oldalak
  'gym': { en: 'gym', fr: 'gym', de: 'gym', hu: 'gym' },
  'biografia': { en: 'biography', fr: 'biographie', de: 'biografie', hu: 'eletrajz' },
  'blog': { en: 'blog', fr: 'blog', de: 'blog', hu: 'blog' },
  'contacto': { en: 'contact', fr: 'contact', de: 'kontakt', hu: 'kapcsolat' },
};

// Funci√≥n para obtener la ruta en espa√±ol desde cualquier idioma
function getSpanishRoute(path: string, fromLang: string): string {
  if (fromLang === 'es') return path;
  
  // Buscar la ruta en espa√±ol que coincida con la traducci√≥n
  for (const [esRoute, translations] of Object.entries(routeTranslations)) {
    if (translations[fromLang as keyof typeof translations] === path) {
      return esRoute;
    }
  }
  
  // Si no se encuentra en el mapa, devolver la ruta original
  return path;
}

// Funci√≥n para traducir la ruta al idioma de destino
function translateRoute(path: string, fromLang: string, toLang: string): string {
  // Si es la home, devolver home
  if (!path || path === '/') return '/';
  
  // Primero obtener la ruta en espa√±ol
  const spanishRoute = getSpanishRoute(path, fromLang);
  
  // Si el idioma de destino es espa√±ol, devolver la ruta espa√±ola
  if (toLang === 'es') return spanishRoute;
  
  // Buscar la traducci√≥n al idioma de destino
  const translation = routeTranslations[spanishRoute as keyof typeof routeTranslations];
  if (translation && translation[toLang as keyof typeof translation]) {
    return translation[toLang as keyof typeof translation];
  }
  
  // FALLBACK: Si la ruta no existe en el mapa, devolver home
  return '/';
}

// Obtener el path sin el prefijo de idioma
// Ejemplo: /es/servicios/talleres ‚Üí servicios/talleres
let pathWithoutLang = currentPath;
if (['es', 'en', 'fr', 'de', 'hu'].includes(potentialLang)) {
  // Remover el idioma del inicio: /es/servicios/talleres ‚Üí /servicios/talleres
  pathWithoutLang = '/' + pathParts.slice(1).join('/');
}
// Normalizar: remover / al inicio y al final
pathWithoutLang = pathWithoutLang.replace(/^\//, '').replace(/\/$/, '');

// Generar URLs traducidas para cada idioma
const translatedUrls = languages.reduce((acc, lang) => {
  // Si estamos en una p√°gina de blog y tenemos localizaciones del art√≠culo
  if (isBlogPage && articleLocalizations && currentSlug) {
    // Buscar la localizaci√≥n para este idioma
    const localization = articleLocalizations.find(loc => loc.locale === lang.code);
    
    if (localization) {
      // El art√≠culo existe en este idioma
      acc[lang.code] = `/${lang.code}/blog/${localization.slug}`;
    } else if (lang.code === currentLang) {
      // Estamos en el idioma actual (aunque no haya localizaci√≥n expl√≠cita)
      acc[lang.code] = `/${lang.code}/blog/${currentSlug}`;
    } else {
      // El art√≠culo no existe en este idioma - ir al listado de blog
      acc[lang.code] = `/${lang.code}/blog`;
    }
  } else {
    // Comportamiento normal para otras p√°ginas
    const translatedPath = translateRoute(pathWithoutLang, currentLang, lang.code);
    // Construir la URL final
    if (!translatedPath || translatedPath === '/') {
      // Para la home
      acc[lang.code] = `/${lang.code}/`;
    } else {
      // Para otras p√°ginas
      acc[lang.code] = `/${lang.code}/${translatedPath}`;
    }
  }
  return acc;
}, {} as Record<string, string>);

// Debug: mostrar las URLs generadas
if (isBlogPage) {
  console.log('üîó Generated URLs:', translatedUrls);
}
---

<div class="group relative" id="language-switcher">
  <button
    type="button"
    class="flex items-center text-sm font-bold uppercase tracking-wider text-current transition-colors hover:text-red-600"
    aria-label="Cambiar idioma"
  >
    {languages.find(lang => lang.code === currentLang)?.name || 'ES'}
    <svg class="ml-1 h-3 w-3 transition-transform group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Dropdown Menu con acento rojo -->
  <div class="invisible absolute right-0 mt-4 w-48 origin-top-right scale-95 border-t-2 border-red-600 bg-white py-2 opacity-0 shadow-2xl transition-all duration-200 group-hover:visible group-hover:scale-100 group-hover:opacity-100">
    {languages.map((lang) => (
      <a
        href={translatedUrls[lang.code]}
        class:list={[
          'block border-l-4 px-6 py-3 text-sm font-semibold uppercase tracking-wider transition-all',
          currentLang === lang.code
            ? 'border-red-600 bg-black text-white'
            : 'border-transparent text-gray-700 hover:border-red-600 hover:bg-gray-50 hover:text-red-600',
        ]}
      >
        <span class="font-bold">{lang.name}</span>
        <span class="ml-2 text-xs opacity-70">{lang.fullName}</span>
      </a>
    ))}
  </div>
</div>
