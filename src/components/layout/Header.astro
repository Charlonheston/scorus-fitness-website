---
/**
 * Header principal del sitio - Con efecto scroll transparente
 * Incluye navegación desktop, selector de idioma y trigger para menú móvil
 */

import Navigation from './Navigation.astro';
import LanguageSwitcher from '@/components/i18n/LanguageSwitcher.astro';
import MobileMenu from './MobileMenu.astro';

// Detectar idioma desde la URL
const currentPath = Astro.url.pathname;
const pathParts = currentPath.split('/').filter(Boolean);
const potentialLang = pathParts[0];
const currentLang = ['en', 'fr', 'de', 'hu'].includes(potentialLang) ? potentialLang : 'es';
---

<header 
  id="main-header" 
  class="fixed top-0 z-50 w-full header-transparent"
>
  <div class="container">
    <div class="flex h-16 md:h-28 items-center justify-between w-full">
      <!-- Logo - Con cambio dinámico blanco/negro -->
      <div class="flex items-center flex-shrink-0">
        <a href={`/${currentLang}/`} class="header-link group flex items-center">
          <!-- Logo Blanco (transparente) -->
          <img 
            id="logo-white"
            src="/images/logos/logo-scorus-white.webp" 
            alt="Scorus Fitness" 
            class="h-12 w-auto transition-all duration-300 group-hover:opacity-80 sm:h-24"
            width="auto"
            height="auto"
            loading="eager"
            decoding="async"
          />
          <!-- Logo Negro (scroll) -->
          <img 
            id="logo-black"
            src="/images/logos/logo-scorus.webp" 
            alt="Scorus Fitness" 
            class="hidden h-12 w-auto transition-all duration-300 group-hover:opacity-80 sm:h-24"
            width="auto"
            height="auto"
            loading="eager"
            decoding="async"
          />
        </a>
      </div>

      <!-- Navegación Desktop + Language Switcher (oculto en móvil) -->
      <div id="header-nav" class="hidden lg:flex lg:items-center lg:space-x-8 ml-auto">
        <Navigation />
        <LanguageSwitcher />
      </div>

      <!-- Menú Móvil (solo visible en móvil) -->
      <div class="flex items-center gap-4 lg:hidden ml-auto flex-shrink-0">
        <LanguageSwitcher />
        <MobileMenu />
      </div>
    </div>
  </div>
</header>

<script>
  // Efecto de scroll para el header con cambio de colores
  function initHeaderScroll() {
    const header = document.getElementById('main-header');
    
    if (!header) return;

    function updateHeader() {
      if (!header) return; // TypeScript null check
      
      const currentScroll = window.scrollY || window.pageYOffset;
      
      // Obtener elementos del NAV principal (EXCLUIR dropdowns)
      const navBar = header.querySelector('#header-nav');
      const mainLinks = navBar ? navBar.querySelectorAll(':scope > nav > div > a, :scope > div > button') : [];
      const mainSpans = navBar ? navBar.querySelectorAll(':scope > nav > div > a > span') : [];
      const mainSvgs = navBar ? navBar.querySelectorAll(':scope > nav > div > a > svg, :scope > div > button > svg') : [];
      
      // Obtener elementos del LOGO
      const logoWhite = header.querySelector('#logo-white') as HTMLElement;
      const logoBlack = header.querySelector('#logo-black') as HTMLElement;
      
      // Obtener elementos móviles (hamburguesa y language switcher)
      const mobileMenuButton = header.querySelector('#mobile-menu-button') as HTMLElement;
      const mobileContainer = header.querySelector('.flex.items-center.gap-4.lg\\:hidden') as HTMLElement;

      if (currentScroll <= 50) {
        // ========== ESTADO TRANSPARENTE (TOP) ==========
        header.style.backgroundColor = 'transparent';
        header.style.boxShadow = 'none';
        header.classList.remove('bg-white', 'shadow-md', 'header-solid');
        header.classList.add('header-transparent');
        
        // Mostrar Logo BLANCO
        if (logoWhite && logoBlack) {
          logoWhite.classList.remove('hidden');
          logoBlack.classList.add('hidden');
        }
        
        // Links principales del NAV en BLANCO (EXCEPTO activos en rojo)
        mainLinks.forEach(el => {
          if (!el.classList.contains('text-red-600')) {
            (el as HTMLElement).style.color = 'white';
            el.classList.add('!text-white');
            el.classList.remove('!text-black');
          }
        });
        
        // Spans de los links en BLANCO
        mainSpans.forEach(el => {
          const closestLink = el.closest('a');
          if (closestLink && !closestLink.classList.contains('text-red-600')) {
            (el as HTMLElement).style.color = 'white';
            el.classList.add('!text-white');
            el.classList.remove('!text-black');
          }
        });
        
        // SVGs principales en BLANCO
        mainSvgs.forEach(el => {
          (el as HTMLElement).style.stroke = 'white';
          (el as HTMLElement).style.color = 'white';
        });
        
        // MOBILE: Hamburguesa en BLANCO
        if (mobileMenuButton) {
          mobileMenuButton.style.color = 'white';
          const hamburgerSvg = mobileMenuButton.querySelector('svg');
          if (hamburgerSvg) {
            hamburgerSvg.style.stroke = 'white';
            hamburgerSvg.style.color = 'white';
          }
        }
        
        // MOBILE: Contenedor móvil en BLANCO
        if (mobileContainer) {
          mobileContainer.style.color = 'white';
        }
        
      } else {
        // ========== ESTADO SÓLIDO (SCROLLED) ==========
        header.style.backgroundColor = 'white';
        header.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
        header.classList.remove('header-transparent');
        header.classList.add('bg-white', 'shadow-md', 'header-solid');
        
        // Mostrar Logo NEGRO
        if (logoWhite && logoBlack) {
          logoWhite.classList.add('hidden');
          logoBlack.classList.remove('hidden');
        }
        
        // Links principales del NAV en NEGRO (EXCEPTO activos en rojo)
        mainLinks.forEach(el => {
          if (!el.classList.contains('text-red-600')) {
            (el as HTMLElement).style.color = 'black';
            el.classList.add('!text-black');
            el.classList.remove('!text-white');
          }
        });
        
        // Spans de los links en NEGRO
        mainSpans.forEach(el => {
          const closestLink = el.closest('a');
          if (closestLink && !closestLink.classList.contains('text-red-600')) {
            (el as HTMLElement).style.color = 'black';
            el.classList.add('!text-black');
            el.classList.remove('!text-white');
          }
        });
        
        // SVGs principales en NEGRO
        mainSvgs.forEach(el => {
          (el as HTMLElement).style.stroke = 'black';
          (el as HTMLElement).style.color = 'black';
        });
        
        // MOBILE: Hamburguesa en NEGRO
        if (mobileMenuButton) {
          mobileMenuButton.style.color = 'black';
          const hamburgerSvg = mobileMenuButton.querySelector('svg');
          if (hamburgerSvg) {
            hamburgerSvg.style.stroke = 'black';
            hamburgerSvg.style.color = 'black';
          }
        }
        
        // MOBILE: Contenedor móvil en NEGRO
        if (mobileContainer) {
          mobileContainer.style.color = 'black';
        }
      }
    }

    // Ejecutar al cargar y al hacer scroll
    window.addEventListener('scroll', updateHeader, { passive: true });
    window.addEventListener('load', updateHeader);
    
    // Ejecutar inmediatamente
    updateHeader();
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeaderScroll);
  } else {
    initHeaderScroll();
  }
</script>

<style>
  /* Estilos para el header con JavaScript dinámico */
  
  /* ASEGURAR QUE EL HEADER SE MANTENGA COMPLETAMENTE FIJO */
  #main-header {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    z-index: 50 !important;
    height: 64px !important;
    min-height: 64px !important;
    max-height: 64px !important;
    box-sizing: border-box !important;
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
  }

  @media (min-width: 768px) {
    #main-header {
      height: 112px !important;
      min-height: 112px !important;
      max-height: 112px !important;
    }
  }

  #main-header .container {
    height: 100% !important;
    display: flex !important;
    align-items: center !important;
    width: 100% !important;
    padding: 0 1rem !important;
    box-sizing: border-box !important;
  }

  #main-header .flex.h-28 {
    height: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  
  /* Asegurar que las clases de Tailwind con ! se apliquen */
  #main-header .\!text-white {
    color: white !important;
  }

  #main-header .\!text-black {
    color: black !important;
  }

  /* Links activos siempre en rojo (en el NAV principal) */
  #main-header nav > div > a.text-red-600,
  #main-header nav > div > a.text-red-600 span {
    color: rgb(220, 38, 38) !important;
  }

  /* Hover en links PRINCIPALES (no dropdowns) siempre en rojo */
  #main-header #header-nav > nav > div > a:hover,
  #main-header #header-nav > div > button:hover {
    color: rgb(220, 38, 38) !important;
  }

  #main-header #header-nav > nav > div > a:hover svg,
  #main-header #header-nav > nav > div > a:hover path,
  #main-header #header-nav > div > button:hover svg,
  #main-header #header-nav > div > button:hover path {
    stroke: rgb(220, 38, 38) !important;
    color: rgb(220, 38, 38) !important;
  }

  /* ========== DROPDOWNS SIEMPRE CON FONDO BLANCO Y TEXTO NEGRO ========== */
  #main-header nav > div > div,
  #main-header .group > div {
    background-color: white !important;
  }

  /* FORZAR texto negro en todos los elementos del dropdown */
  #main-header nav > div > div a,
  #main-header nav > div > div span,
  #main-header .group > div a,
  #main-header .group > div span {
    color: rgb(55, 65, 81) !important;
  }

  /* Hover en dropdowns en ROJO */
  #main-header nav > div > div a:hover,
  #main-header nav > div > div a:hover span,
  #main-header .group > div a:hover,
  #main-header .group > div a:hover span {
    color: rgb(220, 38, 38) !important;
  }

  /* Link activo en dropdown: fondo negro con texto blanco */
  #main-header nav > div > div a.bg-black,
  #main-header nav > div > div a.bg-black span {
    background-color: black !important;
    color: white !important;
  }

  /* Líneas activas en el NAV principal */
  #main-header.header-transparent nav > div > a > span[class*="bg-red"] {
    background-color: white !important;
  }

  #main-header.header-solid nav > div > a > span[class*="bg-red"] {
    background-color: rgb(220, 38, 38) !important;
  }
</style>
